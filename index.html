<!doctype html>
<html lang="id" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0f766e" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="icon" href="/icon.svg" type="image/svg+xml" />
    <title>Log Book Pioner Ramadhan Pro</title>
    <style>
      :root {
        --bg: #f3f7fb;
        --surface: #ffffff;
        --surface-2: #f8fafc;
        --text: #0f172a;
        --muted: #64748b;
        --line: #dbe3ef;
        --primary: #0f766e;
        --primary-2: #0ea5e9;
        --danger: #be123c;
        --shadow: 0 16px 40px rgba(15, 23, 42, 0.09);
      }

      html[data-theme='dark'] {
        --bg: #020617;
        --surface: #0b1220;
        --surface-2: #111827;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --line: #1e293b;
        --primary: #14b8a6;
        --primary-2: #38bdf8;
        --danger: #fb7185;
        --shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, Segoe UI, Arial, sans-serif;
        background: radial-gradient(circle at 90% -10%, rgba(14, 165, 233, 0.14), transparent 36%), var(--bg);
        color: var(--text);
      }

      .bg-blob {
        position: fixed;
        width: 320px;
        height: 320px;
        border-radius: 50%;
        filter: blur(60px);
        opacity: 0.16;
        z-index: -1;
        animation: floatBlob 11s ease-in-out infinite;
      }
      .bg-blob.one { background: #14b8a6; top: -80px; right: -60px; }
      .bg-blob.two { background: #38bdf8; bottom: -100px; left: -80px; animation-delay: 1.7s; }

      @keyframes floatBlob {
        0%, 100% { transform: translateY(0) translateX(0) scale(1); }
        50% { transform: translateY(-16px) translateX(10px) scale(1.06); }
      }

      .app { max-width: 1320px; margin: 0 auto; padding: 18px; }

      .hero {
        border-radius: 20px;
        padding: 18px;
        color: #fff;
        background: linear-gradient(130deg, #0f766e, #0ea5e9);
        box-shadow: var(--shadow);
        display: grid;
        gap: 12px;
        animation: fadeUp .45s ease;
      }
      .hero-top { display: flex; justify-content: space-between; gap: 14px; flex-wrap: wrap; }
      .hero h1 { margin: 0; font-size: clamp(22px, 3vw, 34px); }
      .hero p { margin: 6px 0 0; color: #e0f2fe; }

      .top-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
      .pill { border: 1px solid rgba(255,255,255,.35); border-radius: 999px; padding: 6px 11px; background: rgba(255,255,255,.13); font-size: 12px; }

      button, input, select, textarea { font: inherit; }
      button {
        border-radius: 10px;
        border: 0;
        cursor: pointer;
        padding: 10px 12px;
        transition: transform .16s ease, opacity .16s ease, background .2s ease;
      }
      button:hover { transform: translateY(-1px); }
      button:active { transform: translateY(0); }
      button[disabled] { cursor: not-allowed; opacity: .65; }
      .btn-hero { background: rgba(255,255,255,.14); color: #fff; border: 1px solid rgba(255,255,255,.34); }
      .btn-primary { background: var(--primary); color: #fff; }
      .btn-soft { background: var(--surface-2); color: var(--text); border: 1px solid var(--line); }
      .btn-danger { background: var(--danger); color: #fff; }

      .layout { margin-top: 16px; display: grid; grid-template-columns: 280px 1fr; gap: 16px; }
      .sidebar, .panel { background: var(--surface); border: 1px solid var(--line); border-radius: 16px; box-shadow: var(--shadow); }
      .sidebar { padding: 12px; height: fit-content; position: sticky; top: 10px; animation: fadeUp .5s ease; }
      .nav-btn { width: 100%; text-align: left; border: 1px solid transparent; background: transparent; color: var(--text); margin-bottom: 7px; }
      .nav-btn.active { border-color: #67e8f9; background: color-mix(in oklab, var(--primary) 18%, transparent); }

      .main { display: grid; gap: 16px; }
      .panel { padding: 14px; animation: fadeUp .45s ease; }
      .panel h2 { margin: 0 0 10px; }
      .sub { margin: -4px 0 10px; color: var(--muted); font-size: 13px; }

      .stats { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
      .card {
        background: linear-gradient(180deg, var(--surface), var(--surface-2));
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 11px;
      }
      .card span { color: var(--muted); font-size: 12px; }
      .card b { display: block; font-size: 24px; margin-top: 5px; }

      .grid-2 { display: grid; gap: 11px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
      .grid-3 { display: grid; gap: 11px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }

      label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: var(--muted); }
      input, select, textarea {
        width: 100%;
        border: 1px solid var(--line);
        background: var(--surface);
        color: var(--text);
        border-radius: 10px;
        padding: 9px 11px;
      }
      textarea { min-height: 94px; resize: vertical; }
      .row-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }

      .table-wrap { border: 1px solid var(--line); border-radius: 12px; overflow: auto; }
      table { width: 100%; border-collapse: collapse; min-width: 920px; }
      th, td { border-bottom: 1px solid var(--line); padding: 8px; text-align: left; vertical-align: top; }
      th { background: var(--surface-2); font-size: 12px; color: var(--muted); }

      .member-chip { display: inline-block; border: 1px solid #99f6e4; background: #ecfeff; color: #155e75; border-radius: 999px; padding: 4px 8px; font-size: 12px; }
      html[data-theme='dark'] .member-chip { background: #062531; color: #67e8f9; border-color: #155e75; }

      .progress { margin-top: 6px; height: 8px; background: color-mix(in oklab, var(--line) 75%, transparent); border-radius: 999px; overflow: hidden; }
      .progress > div {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--primary), var(--primary-2));
        transition: width .45s ease;
      }

      .timeline { display: grid; gap: 8px; }
      .timeline-item { border: 1px solid var(--line); border-radius: 12px; padding: 10px; display: flex; justify-content: space-between; gap: 10px; background: var(--surface-2); }
      .task-tags { display: flex; flex-wrap: wrap; gap: 8px; }
      .task-tag { display: inline-flex; gap: 6px; align-items: center; border: 1px solid var(--line); border-radius: 999px; padding: 5px 10px; background: var(--surface-2); }
      .task-tag button { border-radius: 999px; padding: 1px 8px; }

      .hidden { display: none !important; }
      .toast {
        position: fixed; right: 14px; bottom: 14px; z-index: 1000;
        background: #0f172a; color: #fff; border-radius: 10px; padding: 10px 12px;
        transform: translateY(14px); opacity: 0; pointer-events: none; transition: .24s ease;
      }
      .toast.show { opacity: 1; transform: translateY(0); }

      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @media (max-width: 980px) {
        .layout { grid-template-columns: 1fr; }
        .sidebar { position: static; }
      }
    </style>
  </head>
  <body>
    <div class="bg-blob one"></div>
    <div class="bg-blob two"></div>

    <div class="app">
      <header class="hero">
        <div class="hero-top">
          <div>
            <h1>Log Book Pioner Ramadhan Pro</h1>
            <p>UI/UX modern + animasi + fitur detail untuk monitoring amalan keluarga selama Ramadhan.</p>
          </div>
          <div class="top-actions">
            <button id="installBtn" class="btn-hero" disabled>Install App</button>
            <button id="darkModeBtn" class="btn-hero">Mode Gelap</button>
            <span id="installStatus" class="pill">PWA: menunggu dukungan browser</span>
          </div>
        </div>
        <div id="heroStats" class="stats"></div>
      </header>

      <div class="layout">
        <aside class="sidebar">
          <button class="nav-btn active" data-tab="dashboard">üìä Dashboard</button>
          <button class="nav-btn" data-tab="members">üë• Anggota</button>
          <button class="nav-btn" data-tab="logbook">üìù Logbook Harian</button>
          <button class="nav-btn" data-tab="analytics">üìà Analitik</button>
          <button class="nav-btn" data-tab="settings">‚öôÔ∏è Data & Localhost</button>
        </aside>

        <main class="main">
          <section class="panel" data-panel="dashboard">
            <h2>Dashboard Harian</h2>
            <p class="sub">Filter data dan pantau progres harian seluruh anggota.</p>
            <div class="grid-3">
              <div><label for="activeDate">Tanggal aktif</label><input id="activeDate" type="date" /></div>
              <div><label for="memberSearch">Cari anggota</label><input id="memberSearch" type="text" placeholder="Ketik nama anggota..." /></div>
              <div>
                <label for="memberFilter">Filter peran</label>
                <select id="memberFilter">
                  <option value="all">Semua peran</option>
                  <option value="Ayah">Ayah</option>
                  <option value="Ibu">Ibu</option>
                  <option value="Anak">Anak</option>
                  <option value="Lainnya">Lainnya</option>
                </select>
              </div>
            </div>
            <div class="table-wrap" style="margin-top:10px">
              <table>
                <thead><tr><th>Anggota</th><th>Peran</th><th>Target</th><th>Progress</th><th>Status</th><th>Aksi</th></tr></thead>
                <tbody id="dashboardRows"></tbody>
              </table>
            </div>
          </section>

          <section class="panel hidden" data-panel="members">
            <h2>Manajemen Anggota Detail</h2>
            <p class="sub">Simpan profil lengkap agar monitoring lebih spesifik.</p>
            <div class="grid-2">
              <div><label>Nama</label><input id="name" type="text" placeholder="Ahmad Fauzi" /></div>
              <div><label>Peran</label><select id="role"><option>Ayah</option><option>Ibu</option><option>Anak</option><option>Lainnya</option></select></div>
              <div><label>Usia</label><input id="age" type="number" min="1" /></div>
              <div><label>Target Poin Harian</label><input id="target" type="number" min="1" value="5" /></div>
              <div><label>No WhatsApp</label><input id="phone" type="text" placeholder="08xxxxxxxxxx" /></div>
              <div><label>Catatan Khusus</label><input id="note" type="text" placeholder="Fokus tilawah 2 juz" /></div>
            </div>
            <div class="row-actions">
              <button id="addMemberBtn" class="btn-primary">Tambah Anggota</button>
              <button id="clearMembersBtn" class="btn-danger">Hapus Semua Anggota</button>
            </div>
            <div id="memberList" class="timeline" style="margin-top:10px"></div>
          </section>

          <section class="panel hidden" data-panel="logbook">
            <h2>Logbook Detail</h2>
            <p class="sub">Checklist task default + task custom + catatan harian per anggota.</p>
            <div class="grid-2">
              <div><label>Task Custom Baru</label><input id="newTaskInput" type="text" placeholder="Qiyamul Lail" /></div>
              <div><label>&nbsp;</label><button id="addTaskBtn" class="btn-soft">Tambah Task</button></div>
            </div>
            <div id="taskTags" class="task-tags" style="margin-top:8px"></div>
            <div id="logbookContainer" class="timeline" style="margin-top:10px"></div>
          </section>

          <section class="panel hidden" data-panel="analytics">
            <h2>Analitik Progres</h2>
            <p class="sub">Lihat performa global, leaderboard, streak, dan saran perbaikan otomatis.</p>
            <div id="analyticsStats" class="stats"></div>
            <div class="table-wrap" style="margin-top:10px">
              <table>
                <thead><tr><th>#</th><th>Anggota</th><th>Total Checklist</th><th>Rata-rata/Hari</th><th>Streak</th></tr></thead>
                <tbody id="leaderboardRows"></tbody>
              </table>
            </div>
            <div style="margin-top:10px">
              <label>Saran otomatis (berdasarkan data hari aktif)</label>
              <div id="suggestionList" class="timeline"></div>
            </div>
          </section>

          <section class="panel hidden" data-panel="settings">
            <h2>Data, Backup, dan Menjalankan di Localhost</h2>
            <p class="sub">Aplikasi ini langsung bisa dipakai di localhost dengan perintah di bawah.</p>
            <div class="card" style="margin-bottom:10px">
              <span>Perintah localhost</span>
              <b style="font-size:16px">python3 -m http.server 4173</b>
              <span>Lalu akses: http://localhost:4173</span>
            </div>
            <div class="row-actions">
              <button id="exportBtn" class="btn-primary">Export JSON</button>
              <button id="importBtn" class="btn-soft">Import JSON</button>
              <input id="importFile" type="file" accept="application/json" class="hidden" />
              <button id="resetAllBtn" class="btn-danger">Reset Semua</button>
            </div>
            <div class="card" style="margin-top:10px">
              <span>Reminder otomatis (notification)</span>
              <div class="grid-3" style="margin-top:8px">
                <div><label for="reminderMorning">Pagi</label><input id="reminderMorning" type="time" value="04:30" /></div>
                <div><label for="reminderEvening">Sore</label><input id="reminderEvening" type="time" value="18:30" /></div>
                <div><label for="reminderNight">Malam</label><input id="reminderNight" type="time" value="20:00" /></div>
              </div>
              <div class="row-actions">
                <button id="enableReminderBtn" class="btn-soft">Aktifkan Reminder</button>
                <button id="testReminderBtn" class="btn-soft">Tes Notifikasi</button>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>Snapshot data (read only)</label>
              <textarea id="snapshot" readonly></textarea>
            </div>
          </section>
        </main>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      const STORAGE_KEY = 'ramadhan-logbook-pro-v4';
      const DEFAULT_TASKS = ['Sahur','Shalat Subuh','Shalat Dzuhur','Shalat Ashar','Shalat Maghrib','Shalat Isya','Tilawah','Sedekah','Tarawih'];
      const state = { members: [], logs: {}, tasks: [...DEFAULT_TASKS], theme: 'light', reminders: { enabled: false, times: ['04:30','18:30','20:00'], sentToday: {} } };
      let deferredPrompt = null;

      const el = (id) => document.getElementById(id);
      const activeDate = el('activeDate');
      const memberSearch = el('memberSearch');
      const memberFilter = el('memberFilter');
      const dashboardRows = el('dashboardRows');
      const heroStats = el('heroStats');
      const analyticsStats = el('analyticsStats');
      const leaderboardRows = el('leaderboardRows');
      const suggestionList = el('suggestionList');
      const memberList = el('memberList');
      const taskTags = el('taskTags');
      const logbookContainer = el('logbookContainer');
      const snapshot = el('snapshot');
      const installBtn = el('installBtn');
      const installStatus = el('installStatus');
      const toast = el('toast');
      const reminderMorning = el('reminderMorning');
      const reminderEvening = el('reminderEvening');
      const reminderNight = el('reminderNight');

      function toastMsg(msg) {
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 1800);
      }

      function todayKey() { return new Date().toISOString().slice(0, 10); }
      function toDateKey(v) { return new Date(v).toISOString().slice(0, 10); }
      function logKey(memberId, dateKey) { return `${memberId}__${dateKey}`; }

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const parsed = JSON.parse(raw);
          state.members = parsed.members || [];
          state.logs = parsed.logs || {};
          state.tasks = parsed.tasks?.length ? parsed.tasks : [...DEFAULT_TASKS];
          state.theme = parsed.theme || 'light';
          state.reminders = parsed.reminders || state.reminders;
        } catch {
          localStorage.removeItem(STORAGE_KEY);
        }
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        snapshot.value = JSON.stringify(state, null, 2);
      }

      function ensureLog(memberId, dateKey) {
        const key = logKey(memberId, dateKey);
        if (!state.logs[key]) {
          const checks = {};
          state.tasks.forEach((task) => (checks[task] = false));
          state.logs[key] = { checks, note: '', updatedAt: new Date().toISOString() };
        }
        state.tasks.forEach((task) => {
          if (state.logs[key].checks[task] === undefined) state.logs[key].checks[task] = false;
        });
        return state.logs[key];
      }

      function recommendedTarget(role, age) {
        if (role === 'Anak') return age && age < 10 ? 3 : 5;
        if (role === 'Lainnya') return 4;
        return 7;
      }

      function normalizePhone(phone) {
        return phone.replace(/[^\d]/g, '');
      }

      function validateMemberInput(name, phone, role, age) {
        if (!name) return 'Nama wajib diisi';
        const duplicate = state.members.some((m) => m.name.toLowerCase() === name.toLowerCase());
        if (duplicate) return 'Nama sudah ada, gunakan nama berbeda';
        if (phone && !/^08\d{8,13}$/.test(phone)) return 'Format WhatsApp tidak valid (contoh: 081234567890)';
        if (age && (age < 1 || age > 100)) return 'Usia harus antara 1 - 100';
        const suggested = recommendedTarget(role, age);
        const currentTarget = Number(el('target').value || 0);
        if (!currentTarget || currentTarget < 1) el('target').value = String(suggested);
        return null;
      }

      function addMember() {
        const name = el('name').value.trim();
        const role = el('role').value;
        const age = Number(el('age').value || 0);
        const phone = normalizePhone(el('phone').value.trim());
        const error = validateMemberInput(name, phone, role, age);
        if (error) return toastMsg(error);

        const targetInput = Number(el('target').value || 0);
        const target = Math.max(1, targetInput || recommendedTarget(role, age));

        state.members.push({
          id: crypto.randomUUID(),
          name,
          role,
          age,
          target,
          phone,
          note: el('note').value.trim(),
          createdAt: new Date().toISOString()
        });
        ['name','age','phone','note'].forEach((id) => (el(id).value = ''));
        el('target').value = String(recommendedTarget('Anak', 10));
        renderAll();
        toastMsg('Anggota ditambahkan');
      }

      function removeMember(id) {
        state.members = state.members.filter((m) => m.id !== id);
        Object.keys(state.logs).forEach((k) => k.startsWith(`${id}__`) && delete state.logs[k]);
        renderAll();
      }

      function addTask() {
        const t = el('newTaskInput').value.trim();
        if (!t) return;
        if (state.tasks.includes(t)) return toastMsg('Task sudah ada');
        state.tasks.push(t);
        el('newTaskInput').value = '';
        renderAll();
      }

      function removeTask(task) {
        if (DEFAULT_TASKS.includes(task)) return toastMsg('Task default tidak bisa dihapus');
        state.tasks = state.tasks.filter((x) => x !== task);
        Object.values(state.logs).forEach((entry) => delete entry.checks[task]);
        renderAll();
      }

      function clearMembers() {
        if (!confirm('Hapus semua anggota?')) return;
        state.members = [];
        state.logs = {};
        renderAll();
      }

      function memberProgress(memberId, dateKey) {
        const checks = ensureLog(memberId, dateKey).checks;
        const done = Object.values(checks).filter(Boolean).length;
        const total = state.tasks.length;
        return { done, total, percent: total ? Math.round(done / total * 100) : 0 };
      }

      function filteredMembers() {
        const q = memberSearch.value.trim().toLowerCase();
        return state.members.filter((m) => {
          const okRole = memberFilter.value === 'all' || m.role === memberFilter.value;
          const okQuery = !q || m.name.toLowerCase().includes(q);
          return okRole && okQuery;
        });
      }

      function card(label, value, animate = true) {
        const count = String(value).replace(/[^\d]/g, '');
        const attr = animate && count ? ` data-count=\"${count}\"` : '';
        return `<div class=\"card\"><span>${label}</span><b${attr}>${value}</b></div>`;
      }

      function renderHeroStats() {
        const dateKey = toDateKey(activeDate.value || todayKey());
        let totalDone = 0;
        let reachTarget = 0;
        state.members.forEach((m) => {
          const p = memberProgress(m.id, dateKey);
          totalDone += p.done;
          if (p.done >= m.target) reachTarget += 1;
        });
        const totalPossible = state.members.length * state.tasks.length;
        const percent = totalPossible ? Math.round(totalDone / totalPossible * 100) : 0;

        heroStats.innerHTML = [
          card('Anggota Aktif', state.members.length),
          card('Task Aktif', state.tasks.length),
          card('Checklist Hari Ini', `${totalDone}/${totalPossible}`),
          card('Capaian Harian', `${percent}%`),
          card('Capai Target', `${reachTarget} anggota`)
        ].join('');
        animateCounters(heroStats);
      }

      function renderDashboard() {
        const dateKey = toDateKey(activeDate.value || todayKey());
        const rows = filteredMembers().map((m) => {
          const p = memberProgress(m.id, dateKey);
          return `<tr>
            <td><b>${m.name}</b><br/><small>${m.age ? m.age + ' th' : '-'} ‚Ä¢ ${m.phone || '-'}</small></td>
            <td><span class="member-chip">${m.role}</span></td>
            <td>${m.target}</td>
            <td><div class="progress"><div style="width:${p.percent}%"></div></div><small>${p.done}/${p.total} (${p.percent}%)</small></td>
            <td>${p.done >= m.target ? '‚úÖ Tercapai' : '‚è≥ Proses'}</td>
            <td><button class="btn-danger" data-remove="${m.id}">Hapus</button></td>
          </tr>`;
        }).join('');

        dashboardRows.innerHTML = rows || '<tr><td colspan="6">Belum ada data sesuai filter.</td></tr>';
        dashboardRows.querySelectorAll('[data-remove]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-remove');
            const m = state.members.find((x) => x.id === id);
            if (m && confirm(`Hapus ${m.name}?`)) removeMember(id);
          });
        });
      }

      function renderMemberList() {
        if (!state.members.length) {
          memberList.innerHTML = '<div class="timeline-item">Belum ada anggota.</div>';
          return;
        }
        memberList.innerHTML = state.members.map((m) => `
          <div class="timeline-item">
            <div><b>${m.name}</b> <span class="member-chip">${m.role}</span><br/><small>Usia: ${m.age || '-'} | WA: ${m.phone || '-'} | Target: ${m.target}</small><br/><small>Catatan: ${m.note || '-'}</small></div>
            <button class="btn-danger" data-rm-member="${m.id}">Hapus</button>
          </div>
        `).join('');
        memberList.querySelectorAll('[data-rm-member]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-rm-member');
            const m = state.members.find((x) => x.id === id);
            if (m && confirm(`Hapus ${m.name}?`)) removeMember(id);
          });
        });
      }

      function renderTaskTags() {
        taskTags.innerHTML = state.tasks.map((task) => `<span class="task-tag">${task}${DEFAULT_TASKS.includes(task) ? '' : `<button data-rm-task="${task}" class="btn-soft">x</button>`}</span>`).join('');
        taskTags.querySelectorAll('[data-rm-task]').forEach((btn) => btn.addEventListener('click', () => removeTask(btn.getAttribute('data-rm-task'))));
      }

      function renderLogbook() {
        const dateKey = toDateKey(activeDate.value || todayKey());
        if (!state.members.length) {
          logbookContainer.innerHTML = '<div class="timeline-item">Belum ada anggota.</div>';
          return;
        }
        logbookContainer.innerHTML = state.members.map((m) => {
          const log = ensureLog(m.id, dateKey);
          const p = memberProgress(m.id, dateKey);
          const checks = state.tasks.map((task) => `<label style="display:inline-flex;align-items:center;gap:6px;margin:4px 8px 4px 0"><input data-member="${m.id}" data-task="${task}" type="checkbox" ${log.checks[task] ? 'checked' : ''}/> ${task}</label>`).join('');
          return `<div class="timeline-item"><div style="width:100%"><b>${m.name}</b> <small>‚Ä¢ ${dateKey}</small><div style="margin-top:6px">${checks}</div><div style="margin-top:8px"><label>Catatan Harian</label><textarea data-note="${m.id}" placeholder="Tulis catatan...">${log.note || ''}</textarea></div><div class="progress"><div style="width:${p.percent}%"></div></div><small>${p.done}/${p.total} ‚Ä¢ ${p.percent}%</small></div></div>`;
        }).join('');

        logbookContainer.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
          cb.addEventListener('change', (e) => {
            const memberId = e.target.getAttribute('data-member');
            const task = e.target.getAttribute('data-task');
            const log = ensureLog(memberId, dateKey);
            log.checks[task] = e.target.checked;
            log.updatedAt = new Date().toISOString();
            renderAll();
          });
        });

        logbookContainer.querySelectorAll('[data-note]').forEach((txt) => {
          txt.addEventListener('blur', (e) => {
            const memberId = e.target.getAttribute('data-note');
            const log = ensureLog(memberId, dateKey);
            log.note = e.target.value.trim();
            log.updatedAt = new Date().toISOString();
            saveState();
            toastMsg('Catatan tersimpan');
          });
        });
      }

      function streak(memberId) {
        const dates = Object.keys(state.logs).filter((k) => k.startsWith(`${memberId}__`)).map((k) => k.split('__')[1]).sort().reverse();
        let s = 0;
        for (const d of dates) {
          const done = Object.values(ensureLog(memberId, d).checks).filter(Boolean).length;
          if (done > 0) s += 1; else break;
        }
        return s;
      }

      function buildSuggestions(leaderboard, dailyPercent, dateKey) {
        const suggestions = [];

        if (!state.members.length) {
          suggestions.push('Tambahkan minimal 2 anggota supaya analitik keluarga lebih bermakna.');
          return suggestions;
        }

        if (dailyPercent < 40) {
          suggestions.push(`Progress ${dateKey} masih ${dailyPercent}%. Saran: aktifkan target mikro (3 task utama) untuk menaikkan konsistensi.`);
        } else if (dailyPercent < 70) {
          suggestions.push(`Progress ${dateKey} sudah ${dailyPercent}%. Saran: tambah pengingat setelah Maghrib untuk task yang belum dicentang.`);
        } else {
          suggestions.push(`Progress ${dateKey} sangat baik (${dailyPercent}%). Pertahankan ritme dengan review catatan harian sebelum tidur.`);
        }

        const lowStreak = leaderboard.filter((m) => m.streak <= 1).slice(0, 3);
        if (lowStreak.length) {
          suggestions.push(`Fokus pendampingan untuk: ${lowStreak.map((m) => m.name).join(', ')} karena streak masih rendah.`);
        }

        const belowTarget = state.members.filter((m) => memberProgress(m.id, dateKey).done < m.target);
        if (belowTarget.length) {
          suggestions.push(`Anggota belum capai target hari ini: ${belowTarget.map((m) => m.name).join(', ')}. Saran: jadwalkan sesi check-in 10 menit.`);
        }

        const hasCustom = state.tasks.some((t) => !DEFAULT_TASKS.includes(t));
        if (!hasCustom) {
          suggestions.push('Tambahkan 1-2 task custom (mis. Murajaah, Qiyamul Lail) agar program keluarga lebih spesifik.');
        }

        return suggestions;
      }

      function renderAnalytics() {
        const dateKey = toDateKey(activeDate.value || todayKey());
        let totalToday = 0;
        const result = state.members.map((m) => {
          const keys = Object.keys(state.logs).filter((k) => k.startsWith(`${m.id}__`));
          let total = 0;
          keys.forEach((k) => (total += Object.values(state.logs[k].checks || {}).filter(Boolean).length));
          const avg = keys.length ? (total / keys.length).toFixed(1) : '0.0';
          totalToday += memberProgress(m.id, dateKey).done;
          return { ...m, total, avg, streak: streak(m.id) };
        }).sort((a,b) => b.total - a.total);

        const potentialToday = state.members.length * state.tasks.length;
        const dailyPercent = potentialToday ? Math.round(totalToday / potentialToday * 100) : 0;

        analyticsStats.innerHTML = [
          card('Rata-rata Global Hari Ini', `${dailyPercent}%`),
          card('Top Performer', result[0]?.name || '-', false),
          card('Task Tercentang Hari Ini', totalToday),
          card('Total Log Tersimpan', Object.keys(state.logs).length)
        ].join('');
        animateCounters(analyticsStats);

        leaderboardRows.innerHTML = result.map((m, i) => `<tr><td>${i + 1}</td><td>${m.name}</td><td>${m.total}</td><td>${m.avg}</td><td>${m.streak} hari</td></tr>`).join('') || '<tr><td colspan="5">Belum ada data</td></tr>';

        const suggestions = buildSuggestions(result, dailyPercent, dateKey);
        suggestionList.innerHTML = suggestions.map((msg, i) => `<div class="timeline-item"><div><b>Saran ${i + 1}</b><br/><small>${msg}</small></div></div>`).join('');
      }

      function animateCounters(container) {
        container.querySelectorAll('[data-count]').forEach((node) => {
          const end = Number(node.getAttribute('data-count') || 0);
          if (!Number.isFinite(end)) return;
          const duration = 400;
          const start = performance.now();
          function frame(now) {
            const progress = Math.min((now - start) / duration, 1);
            const value = Math.round(end * progress);
            if (/\d+\/$/.test(node.textContent)) return;
            const raw = node.textContent;
            if (raw.includes('%')) node.textContent = `${value}%`;
            else if (/anggota/.test(raw)) node.textContent = `${value} anggota`;
            else node.textContent = String(value);
            if (progress < 1) requestAnimationFrame(frame);
          }
          requestAnimationFrame(frame);
        });
      }

      function exportData() {
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `logbook-ramadhan-${todayKey()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function importData(file) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            state.members = parsed.members || [];
            state.logs = parsed.logs || {};
            state.tasks = parsed.tasks?.length ? parsed.tasks : [...DEFAULT_TASKS];
            state.theme = parsed.theme || 'light';
          state.reminders = parsed.reminders || state.reminders;
            applyTheme();
            renderAll();
            toastMsg('Import berhasil');
          } catch {
            toastMsg('JSON tidak valid');
          }
        };
        reader.readAsText(file);
      }

      function resetAll() {
        if (!confirm('Reset semua data aplikasi?')) return;
        state.members = [];
        state.logs = {};
        state.tasks = [...DEFAULT_TASKS];
        renderAll();
      }

      function applyTheme() {
        document.documentElement.setAttribute('data-theme', state.theme);
      }

      function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        applyTheme();
        saveState();
      }
      function syncReminderInputs() {
        reminderMorning.value = state.reminders.times[0] || '04:30';
        reminderEvening.value = state.reminders.times[1] || '18:30';
        reminderNight.value = state.reminders.times[2] || '20:00';
      }

      async function enableReminders() {
        if (!('Notification' in window)) return toastMsg('Browser tidak mendukung notifikasi');
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return toastMsg('Izin notifikasi ditolak');
        state.reminders.enabled = true;
        state.reminders.times = [reminderMorning.value, reminderEvening.value, reminderNight.value];
        saveState();
        toastMsg('Reminder aktif');
      }

      function sendReminder(title, body) {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification(title, { body, icon: '/icon.svg' });
        }
      }

      function checkReminderTick() {
        if (!state.reminders.enabled) return;
        const now = new Date();
        const hhmm = now.toTimeString().slice(0,5);
        const today = todayKey();
        if (!state.reminders.sentToday[today]) state.reminders.sentToday[today] = {};
        state.reminders.times.forEach((time, idx) => {
          if (time === hhmm && !state.reminders.sentToday[today][time]) {
            state.reminders.sentToday[today][time] = true;
            const labels = ['pagi', 'sore', 'malam'];
            sendReminder('Log Book Ramadhan', `Waktu check-in ${labels[idx]}. Jangan lupa update logbook hari ini.`);
            saveState();
          }
        });
      }

      function testReminder() {
        sendReminder('Tes Reminder', 'Notifikasi berhasil. Reminder siap digunakan.');
        toastMsg('Tes notifikasi dikirim');
      }


      function initTabs() {
        document.querySelectorAll('.nav-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const tab = btn.getAttribute('data-tab');
            document.querySelectorAll('.nav-btn').forEach((n) => n.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('[data-panel]').forEach((p) => p.classList.toggle('hidden', p.getAttribute('data-panel') !== tab));
          });
        });
      }

      async function initPwa() {
        if ('serviceWorker' in navigator) {
          try {
            await navigator.serviceWorker.register('/sw.js');
            installStatus.textContent = 'PWA ready untuk localhost/hosting HTTPS';
          } catch {
            installStatus.textContent = 'Service worker gagal aktif';
          }
        }

        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          installBtn.disabled = false;
          installStatus.textContent = 'App siap di-install';
        });

        window.addEventListener('appinstalled', () => {
          installBtn.disabled = true;
          installStatus.textContent = 'Aplikasi berhasil di-install';
        });

        installBtn.addEventListener('click', async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          installBtn.disabled = true;
        });
      }

      function renderAll() {
        renderHeroStats();
        renderDashboard();
        renderMemberList();
        renderTaskTags();
        renderLogbook();
        renderAnalytics();
        syncReminderInputs();
        saveState();
      }

      el('addMemberBtn').addEventListener('click', addMember);
      el('clearMembersBtn').addEventListener('click', clearMembers);
      el('addTaskBtn').addEventListener('click', addTask);
      el('darkModeBtn').addEventListener('click', toggleTheme);
      memberSearch.addEventListener('input', renderDashboard);
      memberFilter.addEventListener('change', renderDashboard);
      activeDate.addEventListener('change', () => { renderHeroStats(); renderDashboard(); renderLogbook(); renderAnalytics(); });
      el('exportBtn').addEventListener('click', exportData);
      el('importBtn').addEventListener('click', () => el('importFile').click());
      el('importFile').addEventListener('change', (e) => { if (e.target.files[0]) importData(e.target.files[0]); e.target.value = ''; });
      el('resetAllBtn').addEventListener('click', resetAll);
      el('enableReminderBtn').addEventListener('click', enableReminders);
      el('testReminderBtn').addEventListener('click', testReminder);
      el('role').addEventListener('change', () => {
        const age = Number(el('age').value || 0);
        el('target').value = String(recommendedTarget(el('role').value, age));
      });
      el('age').addEventListener('input', () => {
        const age = Number(el('age').value || 0);
        el('target').value = String(recommendedTarget(el('role').value, age));
      });

      activeDate.value = todayKey();
      loadState();
      applyTheme();
      initTabs();
      initPwa();
      renderAll();
      setInterval(checkReminderTick, 30000);
    </script>
  </body>
</html>
